title: GKE GitOps bootstrap
date: '2023-09-04'
excerpt: Jak bÄ›hem pÃ¡r minut bootstrapovat GKE clustery pomocÃ­ GitOps a Terraformu
content: |
  # Jak bÄ›hem pÃ¡r minut bootstrapovat GKE clustery pomocÃ­ GitOps a Terraformu ğŸš€

  PotÅ™ebovali jste nÄ›kdy vytvoÅ™it GKE cluster s nÃ¡stroji jako **ingress-nginx, cert-manager, reloaderâ€¦** a vaÅ¡imi aplikacemi â€” a potÃ© ho po dokonÄenÃ­ POC smazat? Nebo jste moÅ¾nÃ¡ potÅ™ebovali identickou kopii vaÅ¡eho DEV GKE, protoÅ¾e klient poÅ¾adoval novÃ© prostÅ™edÃ­, napÅ™Ã­klad DEV-2?

  Pokud dodrÅ¾ujete principy **GitOps** a **IaC** pro Kubernetes, mÄ›lo by bÃ½t toto snadnÃ©. ZajÃ­mÃ¡ vÃ¡s, jak to dÄ›lÃ¡m jÃ¡? ÄŒtÄ›te dÃ¡l!

  **BTW**: Nebudu vysvÄ›tlovat, co je GitOps nebo IaC â€” pokud to neznÃ¡te, vyhledejte si to.

  V mÃ©m pÅ™Ã­padÄ› Äasto potÅ™ebuji:
  - VytvoÅ™it GKE clustery.
  - Instalovat nÃ¡stroje jako ingress-nginx a konfigurovat cert-manager.
  - Nasadit aplikace.
  - Prezentovat POC a buÄ cluster smazat, nebo ho pÅ™edat klientovi.

  Abych byl co nejefektivnÄ›jÅ¡Ã­, vÅ¡e dÄ›lÃ¡m **kÃ³dem** â€” pomocÃ­ **IaC** a **GitOps**.

  MÅ¯j pÅ™Ã­stup:
  1. VytvoÅ™Ã­m GKE pomocÃ­ **Terraformu** a nasadÃ­m ArgoCD.
  2. Instalaci vÅ¡ech nÃ¡strojÅ¯ v Kubernetes provÃ¡dÃ­m pomocÃ­ **ArgoCD**.

  Tak dost Å™eÄÃ­ â€” pojÄme na kÃ³d! ğŸ’»

  ---

  VeÅ¡kerÃ½ kÃ³d, na kterÃ½ budu odkazovat, je uloÅ¾en v [tomto Git repozitÃ¡Å™i](https://github.com/michalzindulka/k8s-gitops-bootstrap). ğŸ› ï¸

  V repozitÃ¡Å™i je veÅ¡kerÃ½ **IaC kÃ³d** umÃ­stÄ›n v souboru terraform/main.tf. Rychle vysvÄ›tlÃ­m, co dÄ›lÃ¡:
  1. Nejprve vytvoÅ™Ã­ jednoduchÃ½ **GKE Autopilot** cluster.
  2. PotÃ© nakonfiguruje **providery** pro komunikaci s GKE.

  ```
  # JednoduchÃ½ GKE autopilot cluster:
  resource "google_container_cluster" "demo" {
    name     = "gke-demo-${var.resource_suffix}"
    location = var.location

    enable_autopilot    = true
    project             = var.project_id
    deletion_protection = false
  }

  # ZÃ­skÃ¡nÃ­ pÅ™Ã­stupovÃ©ho tokenu a nastavenÃ­ providerÅ¯
  data "google_client_config" "provider" {}

  provider "kubectl" {
    host = "https://${google_container_cluster.demo.endpoint}"
    cluster_ca_certificate = base64decode(
      google_container_cluster.demo.master_auth[0].cluster_ca_certificate,
    )
    token            = data.google_client_config.provider.access_token
    load_config_file = false
  }

  provider "kubernetes" {
    host  = "https://${google_container_cluster.demo.endpoint}"
    token = data.google_client_config.provider.access_token
    cluster_ca_certificate = base64decode(
      google_container_cluster.demo.master_auth[0].cluster_ca_certificate,
    )
  }

  provider "helm" {
    kubernetes {
      host  = "https://${google_container_cluster.demo.endpoint}"
      token = data.google_client_config.provider.access_token
      cluster_ca_certificate = base64decode(
        google_container_cluster.demo.master_auth[0].cluster_ca_certificate,
      )
    }
  }
  ```

  DalÅ¡Ã­ ÄÃ¡stÃ­ je nasazenÃ­ ArgoCD pomocÃ­ Helm.

  ```
  # NasazenÃ­ ArgoCD pomocÃ­ Helm a ignorovÃ¡nÃ­ budoucÃ­ch zmÄ›n
  resource "helm_release" "argocd" {
    repository       = "https://argoproj.github.io/argo-helm"
    chart            = "argo-cd"
    name             = "argocd"
    namespace        = "argocd"
    create_namespace = true
    verify           = false
    version          = var.argocd_version
    wait             = false

    depends_on = [
      google_container_cluster.demo
    ]

    lifecycle {
      ignore_changes = all # Just bootstrap & forget and let ArgoCD do it's job.
    }
  }
  ```

  PÅ™i nasazovÃ¡nÃ­ **ArgoCD** pomocÃ­ Helm zÃ¡mÄ›rnÄ› nastavÃ­m lifecycle na **ignore all changes**. DÅ¯vodem je, Å¾e vÅ¡echny budoucÃ­ aktualizace ArgoCD jsou spravovÃ¡ny samotnÃ½m ArgoCD â€” coÅ¾ je v souladu s filozofiÃ­ GitOps.

  DalÅ¡Ã­m krokem je vytvoÅ™enÃ­ **Kubernetes Secret**. Tento secret je nezbytnÃ½ pro pÅ™Ã­stup ArgoCD k Git repozitÃ¡Å™i, kde jsou uloÅ¾eny vaÅ¡e konfigurace.

  ```
  # VytvoÅ™enÃ­ Kubernetes secret pro pÅ™ihlaÅ¡ovacÃ­ Ãºdaje k repozitÃ¡Å™i ArgoCD
  resource "kubernetes_secret" "argocd_repo_creds" {
    metadata {
      name      = "git-creds"
      namespace = "argocd"
      labels = {
        "argocd.argoproj.io/secret-type" = "repo-creds"
      }
    }

    data = {
      url      = var.git_url
      username = "git"
      password = var.git_pat
    }

    depends_on = [
      helm_release.argocd
    ]
  }
  ```

  Nakonec vytvoÅ™Ã­me root **apps** a **projects**.

  ```
  # Bootstrap ArgoCD aplikacÃ­ a projektÅ¯
  resource "kubectl_manifest" "argocd_apps" {
    yaml_body = templatefile("${path.module}/data/argocd-apps.yaml.tfpl", {
      cluster_name       = google_container_cluster.demo.name
      git_repository_url = var.git_url
    })

    depends_on = [
      helm_release.argocd
    ]
  }

  resource "kubectl_manifest" "argocd_projects" {
    yaml_body = templatefile("${path.module}/data/argocd-projects.yaml.tfpl", {
      cluster_name       = google_container_cluster.demo.name
      git_repository_url = var.git_url
    })

    depends_on = [
      helm_release.argocd
    ]
  }
  ```

  *SamozÅ™ejmÄ› to spouÅ¡tÃ­m jednÃ­m apply, ne po ÄÃ¡stech.*

  PomocÃ­ vÃ½Å¡e uvedenÃ©ho kÃ³du mÃ¡m nynÃ­ **GKE cluster** s **ArgoCD** pÅ™ipojenÃ½m k mÃ©mu GitOps repozitÃ¡Å™i. ğŸ‰

  ---

  ## ğŸ“‚ Struktura GitOps repozitÃ¡Å™e

  DalÅ¡Ã­ ÄÃ¡stÃ­ je struktura GitOps repozitÃ¡Å™e. DodrÅ¾uji nÃ¡sledujÃ­cÃ­ strukturu:

  ```
    .
  â””â”€â”€ clusters
      â””â”€â”€ gke-demo-k8sgibdm
          â”œâ”€â”€ components
          â”‚   â”œâ”€â”€ apps
          â”‚   â”‚   â”œâ”€â”€ argocd.yaml
          â”‚   â”‚   â””â”€â”€ hello-world.yaml
          â”‚   â””â”€â”€ projects
          â”‚       â”œâ”€â”€ apps.yaml
          â”‚       â””â”€â”€ infra.yaml
          â””â”€â”€ config
              â”œâ”€â”€ argocd
              â”‚   â””â”€â”€ values.yaml
              â””â”€â”€ hello-world
                  â””â”€â”€ deploy.yaml
  ```

  Struktura:
  - **SloÅ¾ky clusterÅ¯**:
    KaÅ¾dÃ½ cluster mÃ¡ svou sloÅ¾ku obsahujÃ­cÃ­ vÅ¡e specifickÃ© pro danÃ½ cluster.
  - **components/apps**:
    Tato sloÅ¾ka obsahuje **ArgoCD aplikace**, kterÃ© chci nasadit.
  - **components/projects**:
    Zde definuji ArgoCD projekty.
  - **config**:
    Tato sloÅ¾ka obsahuje buÄ:
    - **HELM values soubory** pro kaÅ¾dou aplikaci.
    - Nebo **Kubernetes manifesty**, pokud nepouÅ¾Ã­vÃ¡m HELM chart.

  JakÃ½koli novÃ½ projekt nebo aplikace pÅ™idanÃ¡ do podsloÅ¾ky components je automaticky detekovÃ¡na a nasazena ArgoCD dÃ­ky **root app/project**, kterÃ© jsem nastavil pomocÃ­ Terraformu.

  Tato struktura zajiÅ¡Å¥uje modularitu, Äistotu a snadnou Å¡kÃ¡lovatelnost.

  ---

  PomocÃ­ tohoto pÅ™Ã­stupu mohu pÅ™ipravit sloÅ¾ku pro kaÅ¾dÃ½ cluster, kterÃ½ potÅ™ebuji, a **bootstrapovat ho bez nÃ¡mahy** pomocÃ­ Terraformu. ğŸš€

  NejlepÅ¡Ã­ na tom je, Å¾e tento pÅ™Ã­stup nenÃ­ omezen na GKE â€” mÅ¯Å¾ete ho pouÅ¾Ã­t pro **AKS, EKS** nebo dokonce **on-premises Kubernetes**. Pro on-prem prostÅ™edÃ­ nahraÄte Terraform **Ansiblem** (kterÃ½ pouÅ¾Ã­vÃ¡m pro svÅ¯j domÃ¡cÃ­ lab).

  ---

  KombinacÃ­ **Terraformu** pro provisioning infrastruktury a **ArgoCD** pro GitOps mÅ¯Å¾ete vytvoÅ™it efektivnÃ­ a opakovatelnÃ½ proces pro sprÃ¡vu Kubernetes clusterÅ¯ â€” aÅ¥ uÅ¾ pro GKE, AKS, EKS nebo vÃ¡Å¡ on-prem lab.

  Tento pÅ™Ã­stup zajiÅ¡Å¥uje konzistenci, Å¡kÃ¡lovatelnost a efektivitu, coÅ¾ Å¡etÅ™Ã­ Äas a ÃºsilÃ­. AÅ¥ uÅ¾ vytvÃ¡Å™Ã­te clustery pro POC nebo spravujete produkÄnÃ­ prostÅ™edÃ­, GitOps s ArgoCD ÄinÃ­ proces bezproblÃ©movÃ½m.

  PÅ™ipraveni to vyzkouÅ¡et? ğŸš€
